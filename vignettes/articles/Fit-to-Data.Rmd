---
title: "Fit to Data"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


In this example here we will show how to fit a MEMC model to experimental data. 


```{r setup}
library(MEMC)

# Packages used in this example 
library(data.table)
library(dplyr)
library(ggplot2)
library(magrittr)
library(knitr)

# set a theme to use in all the plots
theme_set(theme_bw() + theme(legend.title = element_blank()))
```


Load example experimental data provided within the package. 

```{r}
# Load example data we provided as internal package data. 
comp_data <- read.csv(system.file("example/Ultisol_control.csv", package = "MEMC"))
```

## Fit MEND model to experimental data 

The memc contains a function called `memc_modfit` that helps users fit a model run to comparison data. 

```{r}
# Update the MEND model initial state conditions to reflect the experimental set up.
MEND_model$state <- c(P=4.71, M=17.67, Q=0, B=0.82, D=0.148,  EP=0.0082, EM=0.0082, IC=0, Tot=23.484)

# Fit the the "maximum specific decomposition" parameters. 
mend_fit <- memc_modfit(config = MEND_model, comp_data = comp_data, x = c(V.d=2, V.p=5, V.m=0.01))
```


Run the model with the best parameter fits. 

```{r}
mend_out <- solve_model(MEND_model,  0:max(comp_data$time), params = mend_fit$par)

mend_out %>% 
  filter(variable == "IC") %>% 
  ggplot() + 
  geom_line(aes(time, value)) + 
  geom_point(data = comp_data, aes(time, IC)) + 
  labs(title = "Fitted MEMC IC vs Experimental Data", 
       y =  "mg C/g soil")
```

## Fit COMISSION model to experimental data

```{r}
# Update the COMISSSION model initial state conditions to reflect the experimental set up.
COMISSION_model$state <- c(P=4.71, M=17.67, Q=0, B=0.82, D=0.148,  EP=0.0082, EM=0.0082, IC=0, Tot=23.484)

# Fit the the "maximum specific decomposition" parameters. 
comission_fit <- memc_modfit(config = COMISSION_model, comp_data = comp_data, x =c(V.d=2, V.p=5, V.m=0.01))
```


Run the model with the best parameter fits. 

```{r}
comission_out <- solve_model(COMISSION_model,  0:max(comp_data$time), params = comission_fit$par)

comission_out %>% 
  filter(variable == "IC") %>% 
  ggplot() + 
  geom_line(aes(time, value)) + 
  geom_point(data = comp_data, aes(time, IC)) + 
  labs(title = "Fitted MEMC IC vs Experimental Data", 
       y =  "mg C/g soil")
```

## Compare the different model configurations and fits 

How different are the fitted parameter values for the two model configurations? 

```{r, echo=FALSE}
kable(as.data.frame(rbind(c(name = MEND_model$name, round(mend_fit$par, 4)),
                          c(name = COMISSION_model$name, round(comission_fit$par, 4)))))
```


How different is the IC output? 

```{r}
bind_rows(mend_out, comission_out) %>% 
  filter(variable == "IC") %>% 
  ggplot() + 
  geom_line(aes(time, value, color = name, linetype = name), size = 1) + 
  geom_point(data = comp_data, aes(time, IC)) + 
  labs(title = "Fitted MEMC IC vs Experimental Data", 
       y =  "mg C/g soil")
```


```{r}
bind_rows(mend_out, comission_out) %>% 
  ggplot() + 
  geom_line(aes(time, value, color = name, linetype = name), size = 1) + 
  labs(title = "Comparing Two Fitted MEMC Models", 
       y =  "mg C/g soil") + 
  facet_wrap("variable", scales = "free")
```



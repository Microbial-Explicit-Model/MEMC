---
title: "Senstivity Analysis"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The objective of this example is to show users how to do use the MEMC helper functions to easily complete and visualize results from a sensitivity analysis. 


```{r setup}
library(MEMC)
library(ggplot2)

theme_set(theme_bw())
```


We will be using the `memc_sensrange` which is based on the `FME::sensRange` to run two different model configurations. 

Start by setting up the parameters to vary. 
```{r}
pars <- c("V.d" = 3.0e+00,"V.p" = 1.4e+01,"V.m" = 2.5e-01)
```

Set up a data frame defining the parameter ranges to sample from. 
```{r}
prange <- data.frame(min = pars - pars * 0.75, 
                     max = pars + pars * 0.75)
```

Define the time vector to solve the model at. 
```{r}
time <- seq(0, 365)
```

Use `memc_sensrange` to complete the sensitivity analysis for the MEND model. 

```{r, fig.width=6}
MENDsens_out <- memc_sensrange(config = MEND_model, t = time, 
                               pars = pars, parRange = prange, dist = "latin", n = 50)
```


```{r}
mend_to_plot <- format_sensrange(MENDsens_out)
mend_to_plot$name <- "MEND"
```

```{r, fig.width=10}
ggplot(data = mend_to_plot) + 
  geom_ribbon(aes(time, ymin = q25, ymax = q75, fill = "q25/q75"), alpha = 0.5) + 
  geom_line(aes(time, Mean)) + 
  facet_wrap("variable", scales = "free") + 
  labs(y = "mg C/g soil", 
       title = "MEND V.d, V.p, V.m Sensitivity") + 
    theme(legend.title = element_blank())
```




Run the sentivity analysis with the COMISSION model configuration. 

```{r}
COMISSIONsens_out <- memc_sensrange(config = COMISSION_model, t = time, 
                               pars = pars, parRange = prange, dist = "latin", n = 50)
```


```{r}
comission_to_plot <- format_sensrange(COMISSIONsens_out)
comission_to_plot$name <- "COMISSION"
```

```{r, fig.width=10}
ggplot(data = comission_to_plot) + 
  geom_ribbon(aes(time, ymin = q25, ymax = q75, fill = "q25/q75"), alpha = 0.5) + 
  geom_line(aes(time, Mean)) + 
  facet_wrap("variable", scales = "free") + 
  labs(y = "mg C/g soil", 
       title = "COMISSION V.d, V.p, V.m Sensitivity") + 
  theme(legend.title = element_blank())
```


Compare the output between the two models. 

```{r, fig.width=10}
to_plot <- rbind(comission_to_plot, mend_to_plot)
to_plot <- to_plot[to_plot$variable %in% c("P", "M", "Tot"), ]

ggplot(data = to_plot) + 
  geom_ribbon(aes(time, ymin = q25, ymax = q75, fill = name), alpha = 0.4) + 
  geom_line(aes(time, Mean, linetype = name)) + 
  facet_wrap("variable", scales = "free") + 
  labs(y = "mg C/g soil", 
       title = "Sensitivity to V.d, V.p, V.m") + 
  theme(legend.title = element_blank())
```

